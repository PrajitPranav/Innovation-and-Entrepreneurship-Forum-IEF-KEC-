<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>KEC-IEF — Staff Events (Debug)</title>
<link href="https://fonts.googleapis.com/css2?family=Raleway:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  body{font-family:'Raleway',sans-serif;background:#000;color:#fff;margin:0}
  .navbar{backdrop-filter:blur(10px);background:rgba(0,0,0,0.35);padding:12px 24px;position:fixed;top:0;width:100%;z-index:20}
  .container{padding:90px 24px}
  .layout{display:flex;gap:20px}
  .left,.right{flex:1;background:#0f0f10;padding:18px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
  input,select,textarea{width:100%;padding:8px;margin:6px 0;border-radius:6px;background:#0b0b0c;border:1px solid rgba(255,255,255,0.03);color:#fff}
  .btn{padding:8px 12px;border-radius:8px;border:none;background:#fff;color:#000;cursor:pointer;margin-right:8px}
  .event-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:6px;margin-bottom:8px;background:#080809}
  .muted{color:#9aa4b2}
  pre{background:#040405;color:#fff;padding:8px;border-radius:6px;max-height:160px;overflow:auto}
</style>
</head>
<body>
  <div class="navbar"><strong>KEC-IEF — Staff Events (Debug)</strong></div>

  <div class="container">
    <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
      <button id="refreshBtn" class="btn">Refresh</button>
      <div class="muted">Create new event</div>
    </div>

    <div class="layout">
      <div class="left">
        <h3>Create / Edit Event</h3>
        <form id="eventForm">
          <input type="hidden" name="id" id="evId" />
          <label>Title</label><input id="evTitle" name="title" required />
          <label>Date</label><input id="evDate" name="date" type="date" required />
          <label>Time</label><input id="evTime" name="time" placeholder="10:00 AM" />
          <label>Venue</label><input id="evVenue" name="venue" />
          <label>Description</label><textarea id="evDesc" name="description" rows="3"></textarea>
          <div style="margin-top:8px">
            <button type="submit" class="btn">Save</button>
            <button type="button" id="clearBtn" class="btn" style="background:#ccc">Clear</button>
          </div>
        </form>

        <h4 style="margin-top:12px">Last action response</h4>
        <pre id="serverResp">No actions yet</pre>

      </div>

      <div class="right">
        <h3>Existing Events</h3>
        <div id="eventsList" class="muted">Loading…</div>
      </div>
    </div>
  </div>

<script>
  // FORCE API HOST — change to 127.0.0.1 if needed
  const API = 'http://localhost:4000';
  // const API = 'http://127.0.0.1:4000'; // try this if localhost fails

  const evForm = document.getElementById('eventForm');
  const eventsList = document.getElementById('eventsList');
  const refreshBtn = document.getElementById('refreshBtn');
  const clearBtn = document.getElementById('clearBtn');
  const serverResp = document.getElementById('serverResp');

  function logResp(text){ serverResp.textContent = text; console.log('SERVER RESP:', text); }

  async function fetchEvents(){
    try {
      console.log('GET', API + '/api/events');
      const res = await fetch(API + '/api/events');
      const txt = await res.text();
      logResp('GET /api/events — HTTP ' + res.status + '\\n' + txt);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const j = JSON.parse(txt);
      return j.success ? j.items : [];
    } catch (e) {
      console.error('fetchEvents error', e);
      logResp('Network/server error while fetching events: ' + e.message);
      return [];
    }
  }

  function renderEvents(list){
    eventsList.innerHTML = '';
    if (!list.length) return eventsList.innerHTML = '<div class="muted">No events found</div>';
    list.forEach(ev => {
      const div = document.createElement('div'); div.className='event-row';
      div.innerHTML = `<div>
          <div style="font-weight:700">${escapeHtml(ev.title)}</div>
          <div class="muted">${escapeHtml(ev.date)} • ${escapeHtml(ev.time)} • ${escapeHtml(ev.venue)}</div>
        </div>
        <div style="display:flex;gap:6px">
          <button class="btn" onclick="editEvent('${ev._id}')">Edit</button>
          <button class="btn" onclick="deleteEvent('${ev._id}')" style="background:#ef4444;color:#fff">Delete</button>
        </div>`;
      eventsList.appendChild(div);
    });
  }

  async function loadAndShow(){
    const items = await fetchEvents();
    renderEvents(items);
  }

  evForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = document.getElementById('evId').value;
    const body = {
      title: document.getElementById('evTitle').value.trim(),
      date: document.getElementById('evDate').value,
      time: document.getElementById('evTime').value.trim(),
      venue: document.getElementById('evVenue').value.trim(),
      description: document.getElementById('evDesc').value.trim(),
      createdBy: 'staff'
    };
    if (!body.title || !body.date) { alert('Title and date required'); return; }

    try {
      let res, txt;
      if (id) {
        console.log('PATCH', API + '/api/events/' + id, body);
        res = await fetch(API + '/api/events/' + encodeURIComponent(id), {
          method: 'PATCH', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(body)
        });
      } else {
        console.log('POST', API + '/api/events', body);
        res = await fetch(API + '/api/events', {
          method: 'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(body)
        });
      }
      txt = await res.text();
      logResp((id ? 'PATCH' : 'POST') + ' HTTP ' + res.status + '\\n' + txt);
      if (!res.ok) {
        // show error text (server might return HTML or JSON)
        let msg = txt;
        try { const j = JSON.parse(txt); msg = j.error || JSON.stringify(j); } catch(_){}
        alert('Server error: ' + msg);
        return;
      }
      const j = JSON.parse(txt);
      if (j.success) {
        alert('Saved');
        evForm.reset();
        loadAndShow();
      } else {
        alert('Save failed: ' + (j.error || JSON.stringify(j)));
      }
    } catch (err) {
      console.error('Network error', err);
      logResp('Network/server error: ' + err.message);
      alert('Network/server error — open console and check "Last action response" for details.');
    }
  });

  window.editEvent = async function(id) {
    try {
      const res = await fetch(API + '/api/events');
      const txt = await res.text();
      logResp('GET /api/events — HTTP ' + res.status + '\\n' + txt);
      const j = JSON.parse(txt);
      const ev = j.items.find(x=>x._id===id);
      if (!ev) return alert('Not found');
      document.getElementById('evId').value = ev._id;
      document.getElementById('evTitle').value = ev.title;
      document.getElementById('evDate').value = ev.date;
      document.getElementById('evTime').value = ev.time;
      document.getElementById('evVenue').value = ev.venue;
      document.getElementById('evDesc').value = ev.description;
      window.scrollTo({ top: 0, behavior: 'smooth' });
    } catch (e) { console.error(e); alert('Error loading event'); }
  };

  window.deleteEvent = async function(id) {
    if (!confirm('Delete event?')) return;
    try {
      console.log('DELETE', API + '/api/events/' + id);
      const res = await fetch(API + '/api/events/' + encodeURIComponent(id), { method: 'DELETE' });
      const txt = await res.text();
      logResp('DELETE HTTP ' + res.status + '\\n' + txt);
      if (!res.ok) { alert('Delete failed: ' + txt); return; }
      alert('Deleted');
      loadAndShow();
    } catch (e) { console.error(e); alert('Network error deleting'); }
  };

  clearBtn.addEventListener('click', ()=> evForm.reset() );
  refreshBtn.addEventListener('click', loadAndShow);

  function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  // initial
  loadAndShow();
</script>
</body>
</html>
